#!/usr/bin/env python3

# Generate ./api/versioning/BUILD based on packages with files containing
# "package_version_status = ACTIVE."

import os
import string
import subprocess
import sys

BUILD_FILE_TEMPLATE = string.Template(
    """# DO NOT EDIT. This file is generated by tools/proto_format/active_protos_gen.py.

licenses(["notice"])  # Apache 2

load("@rules_proto//proto:defs.bzl", "proto_library")

# This track active development versions of protos.
proto_library(
    name = "active_protos",
    visibility = ["//visibility:public"],
    deps = [
$active_pkgs
    ],
)
""")


# Key sort function to achieve consistent results with buildifier.
def BuildOrderKey(key):
  return key.replace(':', '!')


def DepsFormat(pkgs):
  return '\n'.join(
      '        "//%s:pkg",' % p.replace('.', '/') for p in sorted(pkgs, key=BuildOrderKey))


if __name__ == '__main__':
  api_root = sys.argv[1]
  api_protos = subprocess.check_output(
      ['grep', '-l', '-r', 'package_version_status = ACTIVE;',
       api_root]).decode().strip().split('\n')
  active_pkgs = set([os.path.dirname(p)[len(api_root) + 1:] for p in api_protos])
  sys.stdout.write(BUILD_FILE_TEMPLATE.substitute(active_pkgs=DepsFormat(active_pkgs)))
